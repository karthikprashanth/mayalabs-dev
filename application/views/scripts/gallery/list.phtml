<script type = "text/javascript" src = "/js/ajaxupload.3.6.js"></script>
<script type = "text/javascript">
	var imageNo = 0;
	function showImg(id){
            document.getElementById("large-img").src = "/uploads/gallery/photo_" + id + ".jpg";
            $("#photo-box").dialog({height:'auto',width:'auto',title:$("#img-"+id).attr("alt")});
        }
        
	$(document).ready(function(){
            
		new AjaxUpload("#image",{
			action: '/gallery/upload',
			name : 'image',
			onSubmit : function(file,ext){
				this.disable();
			},
			onComplete: function(file, response){
	            this.enable();
	            var data = response.split("<");
	            var json = eval("(" + data[0] + ")");
	            var content = "";
	            var colNo;
	            var rowNo;
	            $.ajax({
	            	type:"POST",
	            	data:"cid=" + $("#cid").val() + "&tag=" + $("#tag").val() + 
	            	     "&imgPath="+encodeURI(json.imgPath)+"&thumbPath="+encodeURI(json.thumbPath),
	            	     
	            	dataType:"json",
	            	url:"/gallery/add",
	            	success:function(msg){
	            		if(msg != ''){	            			
							rowNo = Math.floor(imageNo/3);
							if(imageNo == 0 || imageNo%3 == 0){
								content = "<tr><td id = 'img" + rowNo + "-0'><img src = '" + msg.thumbPath + "' alt = '" + msg.tag + "' onclick='showImg(" + msg.imgId + ")'></td>" +
								               "<td id = 'img" + rowNo + "-1'></td>" +
								               "<td id = 'img" + rowNo + "-2'></td>";								
								$("#image").append(content);
							}		
							else {
								colNo = imageNo - (rowNo*3);								
								$("#img"+rowNo+"-"+colNo).html("<img src = '" + msg.thumbPath + "' alt = '" + msg.tag + "' id = 'img-" + msg.imgId + "' onclick='showImg(" + msg.imgId + ")'>");
							}
							imageNo++;
	            		}
                                $("#gallery-form").dialog('close');
	            	}
	            });
	        }
		});
		
		$("#add-photo").click(function(){
                        $("#tag").val("");
			$("#gallery-form").dialog({title:"Add a new Photo",width:430});
		});
	});
</script>
<div id = "gallery-form" style="display:none">
	<?php echo $this->galleryForm; ?>
	<input type = 'hidden' id = 'cid' value = '<?php echo $this->cid;?>'>
</div>
<div id ="photo-box"style="display:none"><img id='large-img'></div>
<table id="image">
	<?php
		$imageNo = 0;
		foreach($this->photos as $photo){
                        continue;
			$thumbPath = "uploads/".$imageNo.".jpg";
			file_put_contents($thumbPath,$photo['data']);
			$row = floor($imageNo/4);
			if($imageNo == 0 || $imageNo%4 == 0){
				echo "<tr>";
			}
			echo "<td id = 'img$row-0'><img src = '" . $thumbPath . "' alt = '" . $photo['photoId'] . "'></td>";
			if($imageNo%3==0){
				echo "</tr>";
			}
			$imageNo++;
		}
	?>	
</table>
<?php
	if($this->allowed){
		echo "<button id='add-photo' class = 'gt-add'>Add Photo</button>";
	}
?>